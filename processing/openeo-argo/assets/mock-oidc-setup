#!/bin/bash
# Mock OIDC setup for Killercoda demo environment
set -e

echo "Setting up mock OIDC provider..."

# Create namespace first
kubectl create namespace openeo --dry-run=client -o yaml | kubectl apply -f -

# Wait for openeo deployment to be ready (we need the pod to generate keys)
echo "Waiting for OpenEO pod to be ready..."
kubectl rollout status deployment openeo-openeo-argo -n openeo --timeout=300s 2>/dev/null || true

# Generate RSA keypair inside the openeo pod
echo "Generating RSA keypair..."
KEYS=$(kubectl exec -n openeo deploy/openeo-openeo-argo -c openeo-argo -- python3 -c '
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.primitives.asymmetric import rsa
from cryptography.hazmat.backends import default_backend
import base64, json

private_key = rsa.generate_private_key(public_exponent=65537, key_size=2048, backend=default_backend())
public_numbers = private_key.public_key().public_numbers()

def int_to_base64(n):
    data = n.to_bytes((n.bit_length() + 7) // 8, byteorder="big")
    return base64.urlsafe_b64encode(data).rstrip(b"=").decode("ascii")

jwks = {"keys": [{"kty": "RSA", "use": "sig", "alg": "RS256", "kid": "demo-key-1", "n": int_to_base64(public_numbers.n), "e": int_to_base64(public_numbers.e)}]}
private_pem = private_key.private_bytes(encoding=serialization.Encoding.PEM, format=serialization.PrivateFormat.PKCS8, encryption_algorithm=serialization.NoEncryption()).decode("utf-8")

print("JWKS=" + json.dumps(jwks))
print("PRIVATE_KEY_B64=" + base64.b64encode(private_pem.encode()).decode())
')

JWKS=$(echo "$KEYS" | grep "^JWKS=" | cut -d= -f2-)
PRIVATE_KEY_B64=$(echo "$KEYS" | grep "^PRIVATE_KEY_B64=" | cut -d= -f2-)

mkdir -p /root/.eoepca
echo "$PRIVATE_KEY_B64" > /root/.eoepca/openeo-private-key.b64

# Deploy mock OIDC
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: mock-oidc-config
  namespace: openeo
data:
  nginx.conf: |
    events { worker_connections 1024; }
    http {
      server {
        listen 80;
        location /realms/eoepca/.well-known/openid-configuration {
          default_type application/json;
          return 200 '{"issuer":"http://dummy-oidc-local.openeo.svc.cluster.local/realms/eoepca","jwks_uri":"http://dummy-oidc-local.openeo.svc.cluster.local/realms/eoepca/protocol/openid-connect/certs","userinfo_endpoint":"http://dummy-oidc-local.openeo.svc.cluster.local/realms/eoepca/protocol/openid-connect/userinfo"}';
        }
        location /realms/eoepca/protocol/openid-connect/certs {
          default_type application/json;
          return 200 '$JWKS';
        }
        location /realms/eoepca/protocol/openid-connect/userinfo {
          default_type application/json;
          return 200 '{"sub":"eoepcauser","preferred_username":"eoepcauser"}';
        }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mock-oidc
  namespace: openeo
spec:
  replicas: 1
  selector:
    matchLabels: {app: mock-oidc}
  template:
    metadata:
      labels: {app: mock-oidc}
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports: [{containerPort: 80}]
        volumeMounts: [{name: config, mountPath: /etc/nginx/nginx.conf, subPath: nginx.conf}]
      volumes:
      - name: config
        configMap: {name: mock-oidc-config}
---
apiVersion: v1
kind: Service
metadata:
  name: dummy-oidc-local
  namespace: openeo
spec:
  selector: {app: mock-oidc}
  ports: [{port: 80, targetPort: 80}]
EOF

kubectl rollout status deployment mock-oidc -n openeo --timeout=120s
echo "âœ… Mock OIDC deployed"